---
import StarlightIcon from '@astrojs/starlight/user-components/Icon.astro';

interface Props {
  name: string;
  label?: string;
  color?: string;
  size?: string;
  class?: string;
}

const { name, label, color, size, class: className } = Astro.props;
const isScoped = name.includes(':');

let svgBody = '';
let viewBox = '0 0 24 24';

if (isScoped) {
  const colonIndex = name.indexOf(':');
  const prefix = name.slice(0, colonIndex);
  const iconName = name.slice(colonIndex + 1);

  let iconData: any;

  switch (prefix) {
    case 'lucide':
      iconData = (await import('@iconify-json/lucide/icons.json')).default;
      break;
    case 'carbon':
      iconData = (await import('@iconify-json/carbon/icons.json')).default;
      break;
    case 'mdi':
      iconData = (await import('@iconify-json/mdi/icons.json')).default;
      break;
    case 'phosphor':
      iconData = (await import('@iconify-json/ph/icons.json')).default;
      break;
    case 'tabler':
      iconData = (await import('@iconify-json/tabler/icons.json')).default;
      break;
    case 'f5-brand':
      iconData = (await import('@robinmordasiewicz/icons-f5-brand/icons.json')).default;
      break;
    case 'hashicorp-flight':
      iconData = (await import('@robinmordasiewicz/icons-hashicorp-flight/icons.json')).default;
      break;
    default:
      throw new Error(
        `Unknown icon prefix "${prefix}". Available: lucide, carbon, mdi, phosphor, tabler, f5-brand, hashicorp-flight`
      );
  }

  const icon = iconData.icons?.[iconName];
  if (!icon) {
    throw new Error(`Icon "${iconName}" not found in "${prefix}" icon set.`);
  }

  svgBody = icon.body;
  const w = icon.width ?? iconData.width ?? 24;
  const h = icon.height ?? iconData.height ?? 24;
  viewBox = `0 0 ${w} ${h}`;
}

const a11yAttrs = label
  ? { 'aria-label': label }
  : { 'aria-hidden': 'true' };

const styleParts: string[] = [];
if (color) styleParts.push(`--sl-icon-color: ${color}`);
if (size) styleParts.push(`--sl-icon-size: ${size}`);
const inlineStyle = styleParts.length ? styleParts.join('; ') : undefined;
---

{isScoped ? (
  <><svg
    {...a11yAttrs}
    class={className}
    width="16"
    height="16"
    fill="currentColor"
    viewBox={viewBox}
    style={inlineStyle}
    set:html={svgBody}
  /></>
) : (
  <StarlightIcon name={name as any} label={label} color={color} size={size} class={className} />
)}

<style>
  svg {
    color: var(--sl-icon-color);
    font-size: var(--sl-icon-size, 1em);
    width: 1em;
    height: 1em;
  }
</style>
